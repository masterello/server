<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.1/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.23.0/picker.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        #emoji-picker {
            position: absolute;
            display: none;
            z-index: 10000;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            width: 300px;
        }
    </style>
</head>
<body>
<div>
    <h2>Chat</h2>
    <input type="text" id="userId" placeholder="Enter User ID">
    <input type="text" id="workerId" placeholder="Enter Worker ID">
    <button onclick="getOrCreateChat()">Get or Create Chat</button>

    <div style="margin-top:8px;">
        <input type="text" id="chatId" placeholder="Chat ID">
        <button onclick="connectToChat()">Connect</button>
    </div>

    <div style="margin-top:8px;">
        <span>Presence: </span>
        <span id="presence-user" style="margin-right:12px;">User: unknown</span>
        <span id="presence-worker">Worker: unknown</span>
    </div>
    <div style="margin-top:4px;">
        <span>Typing: </span>
        <span id="typing-user" style="margin-right:12px;">User: -</span>
        <span id="typing-worker">Worker: -</span>
    </div>

    <div style="margin-top:8px;">
        <input type="text" id="message" placeholder="Type a message">
        <button onclick="sendMessage()">Send</button>
        <button id="emojiButton">ðŸ˜Š</button>
    </div>
    <table id="messages">
        <thead>
        <tr>
            <th>Created At</th>
            <th>Created By</th>
            <th>Message</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <emoji-picker id="emoji-picker"></emoji-picker>
</div>

<script>
    var stompClient = null;
    var messagesMap = new Map(); // Store messages as a map with id as key
    var currentChat = null; // Store chat details
    var presenceInterval = null; // Interval id for presence pings

    async function getOrCreateChat() {
        const userId = document.getElementById('userId').value;
        const workerId = document.getElementById('workerId').value;

        if (!userId || !workerId) {
            alert("Please enter User ID and Worker ID.");
            return;
        }

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: userId,
                    workerId: workerId
                }),
            });

            if (response.ok) {
                const chat = await response.json();
                currentChat = chat; // Save the chat details for use in message processing
                document.getElementById('chatId').value = chat.id;
                alert(`Chat created or retrieved successfully! Chat ID: ${chat.id}`);
            } else {
                alert("Failed to create or retrieve chat.");
            }
        } catch (error) {
            console.error("Error creating or retrieving chat:", error);
        }
    }

    function connectToChat() {
        var chatId = document.getElementById('chatId').value;
        if (!chatId) {
            alert("Please get or create a chat first.");
            return;
        }

        var socket = new SockJS('/ws/chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log("Connected: " + frame);

            // Subscribe to the messages topic
            stompClient.subscribe('/topic/messages/' + chatId, function (messageOutput) {
                var message = JSON.parse(messageOutput.body);
                addMessageToMap(message);
                displayMessages();
            });

            // Subscribe to presence updates
            stompClient.subscribe('/topic/presence/' + chatId, function (presenceOutput) {
                var snapshot = JSON.parse(presenceOutput.body);
                updatePresence(snapshot);
            });

            // Subscribe to typing updates
            stompClient.subscribe('/topic/typing/' + chatId, function (typingOutput) {
                var evt = JSON.parse(typingOutput.body);
                updateTyping(evt);
            });

            // Kick off presence ping immediately and then every 15s
            sendPresencePing(chatId);
            if (presenceInterval) clearInterval(presenceInterval);
            presenceInterval = setInterval(function() { sendPresencePing(chatId); }, 15000);

            // Fetch chat history
            fetchChatHistory(chatId);
        }, function (error) {
            console.error("Connection error:", error);
        });
    }

    async function fetchChatHistory(chatId) {
        try {
            const response = await fetch(`/api/chat/${chatId}/history`);
            if (!response.ok) {
                throw new Error("Failed to fetch chat messages.");
            }

            const history = await response.json();

            history.messages.forEach(function (message) {
                addMessageToMap(message);
            });

            displayMessages();
        } catch (error) {
            console.error("Failed to fetch chat history:", error);
        }
    }

    function addMessageToMap(message) {
        if (!messagesMap.has(message.id)) {
            messagesMap.set(message.id, message);
        }
    }

    function displayMessages() {
        // Sort messages by createdAt
        const sortedMessages = Array.from(messagesMap.values()).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

        var tbody = document.getElementById('messages').getElementsByTagName('tbody')[0];
        tbody.innerHTML = ''; // Clear current table content

        sortedMessages.forEach(function (message) {
            var row = tbody.insertRow();

            var createdAtCell = row.insertCell(0);
            createdAtCell.textContent = message.createdAt;

            var authorCell = row.insertCell(1);
            // Determine author name based on createdBy field
            if (message.createdBy === currentChat.userId) {
                authorCell.textContent = currentChat.userName;
            } else if (message.createdBy === currentChat.workerId) {
                authorCell.textContent = currentChat.workerName;
            } else {
                authorCell.textContent = "Unknown";
            }

            var messageCell = row.insertCell(2);
            messageCell.textContent = message.message;
        });
    }

    function sendMessage() {
        var message = document.getElementById('message').value;
        var chatId = document.getElementById('chatId').value;

        if (!chatId) {
            alert("Please get or create a chat first.");
            return;
        }

        if (message) {
            stompClient.send("/ws/sendMessage/" + chatId, {}, message);
            document.getElementById('message').value = ''; // Clear input after sending
        } else {
            alert("Please type a message.");
        }
    }

    const emojiPicker = document.getElementById('emoji-picker');
    const emojiButton = document.getElementById('emojiButton');
    const messageInput = document.getElementById('message');

    emojiButton.addEventListener('click', function(event) {
        event.stopPropagation();
        const buttonRect = emojiButton.getBoundingClientRect();
        emojiPicker.style.left = `${buttonRect.left}px`;
        emojiPicker.style.top = `${buttonRect.bottom + window.scrollY}px`;
        emojiPicker.style.display = (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') ? 'block' : 'none';
    });

    emojiPicker.addEventListener('emoji-click', function(event) {
        messageInput.value += event.detail.unicode;
        emojiPicker.style.display = 'none';
    });

    document.addEventListener('click', function(event) {
        if (!emojiButton.contains(event.target) && !emojiPicker.contains(event.target)) {
            emojiPicker.style.display = 'none';
        }
    });

    // Typing indicator logic
    var typingState = { started: false, timeoutId: null };
    messageInput.addEventListener('input', function() {
        var chatId = document.getElementById('chatId').value;
        if (!chatId || !stompClient || !stompClient.connected) return;
        if (!typingState.started) {
            typingState.started = true;
            stompClient.send('/ws/typing/' + chatId, {}, JSON.stringify({ started: true }));
        }
        if (typingState.timeoutId) clearTimeout(typingState.timeoutId);
        typingState.timeoutId = setTimeout(function() {
            typingState.started = false;
            stompClient.send('/ws/typing/' + chatId, {}, JSON.stringify({ started: false }));
        }, 1500);
    });

    function sendPresencePing(chatId) {
        if (!stompClient || !stompClient.connected) return;
        stompClient.send('/ws/presence/ping/' + chatId, {}, 'ping');
    }

    function updatePresence(snapshot) {
        if (!snapshot || !snapshot.participants) return;
        var userSpan = document.getElementById('presence-user');
        var workerSpan = document.getElementById('presence-worker');

        var userId = currentChat ? currentChat.userId : null;
        var workerId = currentChat ? currentChat.workerId : null;

        var userEntry = snapshot.participants.find(function(p) { return p.userId === userId; });
        var workerEntry = snapshot.participants.find(function(p) { return p.userId === workerId; });

        userSpan.textContent = 'User: ' + (userEntry ? userEntry.status : 'unknown');
        workerSpan.textContent = 'Worker: ' + (workerEntry ? workerEntry.status : 'unknown');
    }

    function updateTyping(evt) {
        if (!evt || !currentChat) return;
        var userSpan = document.getElementById('typing-user');
        var workerSpan = document.getElementById('typing-worker');
        if (evt.userId === currentChat.userId) {
            userSpan.textContent = 'User: ' + (evt.started ? 'typingâ€¦' : '-');
        } else if (evt.userId === currentChat.workerId) {
            workerSpan.textContent = 'Worker: ' + (evt.started ? 'typingâ€¦' : '-');
        }
    }
</script>
</body>
</html>
